version: "3.8"
services:
    # basic drupal site installation with dependencies and permissions configured
    # use `docker exec -ti journal-cms_app_1 /bin/bash` to get a shell
    app:
        build: .
        image: elifesciences/journal-cms #:${IMAGE_TAG}
        volumes:
            # todo: ensure writeable by www-data
            - /var/log/journal-cms:/srv/journal-cms/private/monolog
            - ./web/sites/default:/srv/journal-cms/web/sites/default
        ports:
            - "9000:9000"
        networks:
            - internal
            - external

    # mysql database
    db:
        image: mysql:5.7
        command: --default-authentication-plugin=mysql_native_password
        environment:
            MYSQL_DATABASE: journal_cms
            MYSQL_USER: journal_cms
            MYSQL_PASSWORD: journal_cms
            MYSQL_ROOT_PASSWORD: journal_cms #${MYSQL_ROOT_PASSWORD}
        volumes:
            # ensure the database doesn't live within the container.
            # the database must be preserved between container restarts
            - ./mysql:/var/lib/mysql
        networks:
            - internal

    # caching
    # use `docker exec -it <container-process-id> redis-cli` to get a shell
    redis:
        image: redis:4.0-alpine
        networks:
            - internal

    # continue with installation now that drupal has been connected to a database
    configure:
        image: elifesciences/journal-cms
        entrypoint: ["./wait-for-it.sh", "db:3306", "-t", "120", "--"]
        command: ./configure.sh
        depends_on:
            - app
            - db
            - redis
        networks:
            - internal

    nginx:
        profiles:
            - dev
        image: nginx:stable
        ports:
            - "8080:81"
        volumes:
            - ./container/dev/nginx/templates:/etc/nginx/templates
            - ./web/sites/default:/srv/journal-cms/web
            - ./web/core:/srv/journal-cms/web/core
        environment:
            - NGINX_HOST=localhost
            - NGINX_PORT=81
        networks:
            - internal
            - external

networks:
    external:
        external: true
        driver: bridge
    internal:
        driver: bridge
